---
title: MQTT从入门到入坟 - 01概述
comments: false
date: 2024-06-10 09:38:42
tags:
    - MQTT从入门到入坟
categories:
    - MQTT
keywords:
    - MQTT概述
description:
top_img:
cover: https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240610094240.png
abbrlink:
---

## 简述

&emsp;&emsp;MQTT（`Message Queuing Telemetry Transport`）消息队列遥测传输协议是一种轻量级的发布/订阅消息传输协议，特别适用于需要远程监控的物联网（IoT）设备和小型传感器。这种协议的设计目标是实现低带宽和高延迟的网络环境中的可靠通信。
&emsp;&emsp;MQTT是一个基于客户端-服务器的消息发布/订阅传输协议。MQTT协议是轻量、简单、开放和易于实现的。MQTT被广泛用于物联网领域，包括但不限于以下场景：

- **智能家居**：连接各种家用设备，如灯光、温控器和安全系统
- **工业自动化**：监控和控制工业设备和传感器
- **远程监控**：实时监控远程设备和环境参数，如农业监控和环境监测

![](https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240610100954.png)

{% note info %}
MQTT协议由于其轻量级和高效性，成为物联网设备通信的理想选择。其发布/订阅模式和多种消息传递保证机制，使得它能够在不同的网络环境中可靠地传输数据。
{% endnote %}

## 设计规范

&emsp;&emsp;由于物联网的环境是非常特别的，所以MQTT遵循以下设计原则：

- **精简**，只保留必要功能，避免冗余，确保协议轻量级和高效运行
- **发布/订阅(Pub/Sub)模式**，采用发布/订阅（Pub/Sub）模式，简化传感器和设备之间的消息传递，提高系统扩展性和灵活性。
- **动态主题创建**，允许用户根据需要动态创建主题，降低运维成本，提供灵活的主题管理。
- **低传输量**，设计精简的消息格式和数据包头，减少传输数据量，提高传输效率，适应低带宽环境
- **网络适应性**，考虑低带宽、高延迟和不稳定网络的因素，确保在各种网络条件下可靠通信。
- **连续会话控制**，支持持久化会话，保持客户端断线重连后的数据一致性和订阅状态。
- **低计算能力支持**，设计适应低计算能力的客户端，使资源受限的设备能够高效运行。
- **服务质量管理**，提供三种服务质量（QoS）级别（QoS 0、QoS 1、QoS 2），根据不同应用场景选择适当的消息传递保障。
- **数据灵活性**，不对传输数据的类型和格式做硬性规定，保持数据传输的灵活性和兼容性。

## 主要特性

&emsp;&emsp;MQTT协议工作在低带宽、不可靠的网络的远程传感器和控制设备通讯而设计的协议，它具有以下主要的几项特性：

1. 使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合。这一点很类似于XMPP，但是MQTT的信息冗余远小于XMPP，,因为XMPP使用XML格式文本来传递数据。
1. 对负载内容屏蔽的消息传输。
1. 使用TCP/IP提供网络连接。主流的MQTT是基于TCP连接进行数据推送的，但是同样有基于UDP的版本，叫做MQTT-SN。这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。
1. 有三种消息发布服务质量：
    -  “至多一次”，消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。这一种方式主要普通APP的推送，倘若你的智能设备在消息推送时未联网，推送过去没收到，再次联网也就收不到了。
    - “至少一次”，确保消息到达，但消息重复可能会发生。
    - “只有一次”，确保消息到达一次。在一些要求比较严格的计费系统中，可以使用此级别。在计费系统中，消息重复或丢失会导致不正确的结果。这种最高质量的消息发布服务还可以用于即时通讯类的APP的推送，确保用户收到且只会收到一次。
1. 小型传输，开销很小（固定长度的头部是2字节），协议交换最小化，以降低网络流量。这就是为什么在介绍里说它非常适合“在物联网领域，传感器与服务器的通信，信息的收集”，要知道嵌入式设备的运算能力和带宽都相对薄弱，使用这种协议来传递消息再适合不过了。
1. 使用Last Will和Testament特性通知有关各方客户端异常中断的机制。
    - Last Will：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。
    - Testament：遗嘱机制，功能类似于Last Will。

## MQTT协议原理

### MQTT协议实现方式

&emsp;&emsp;实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT协议中有三种身份：`发布者（Publish）`、`代理（Broker）（服务器）`、`订阅者（Subscribe）`。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。
&emsp;&emsp;MQTT传输的消息分为：`主题(Topic)`和`负载(Payload)`两部分：
- **Topic**：可以理解为消息的类型，订阅者订阅(`Subscribe`)后，就会收到该主题的消息内容(`payload`)
- **Payload**：可以理解为消息的内容，是指订阅者具体要使用的内容

### 网络传输与应用消息

&emsp;&emsp;MQTT会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。当应用数据通过MQTT网络发送时，MQTT会把与之相关的服务质量（QoS）和主题名（Topic）相关连。

### MQTT客户端

&emsp;&emsp; 一个使用MQTT协议的应用程序或者设备，它总是建立到服务器的网络连接。客户端可以：
- 发布其他客户端可能会订阅的消息
- 订阅其他客户端发布的消息
- 退订或删除应用程序的消息
- 断开与服务器连接

### MQTT服务器

&emsp;&emsp;MQTT服务器以称为“消息代理”（Broker），可以是一个应用程序或一台设备。它是位于消息发布者和订阅者之间，它可以：
- 接受来自客户端的网络连接
- 接受客户端发布的应用信息
- 处理来自客户端的订阅和退订的请求
- 向订阅的客户转发应用程序消息

### MQTT协议中的订阅/主题/会话

#### 订阅(Subscripotion)

&emsp;&emsp;订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。

#### 会话(Session)

&emsp;&emsp;每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。

#### 主题名(Topic Name)

&emsp;&emsp;连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。

#### 主题筛选器(Topic Filter)

&emsp;&emsp;一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。

#### 负载(Payload)

&emsp;&emsp;消息订阅者所具体接收的内容

### MQTT协议中的方法

&emsp;&emsp;MQTT协议中定义了一些方法（也被称为动作），来于表示对确定资源所进行操作。这个资源可以代表预先存在的数据或动态生成数据，这取决于服务器的实现。通常来说，资源指服务器上的文件或输出。主要方法有：

- `Connect`：等待与服务器建立连接
- `Disconnect`：等待MQTT客户端完成所做的工作，并于服务器断开TCP/IP会话
- `Subscribe`：等待完成订阅
- `UnSubscribe`：等待服务器取消客户端的一个或多个topics订阅
- `Publish`：MQTT客户端发送消息请求，发送完成后返回应用程序线程

## MQTT协议数据包结构

&emsp;&emsp; 在MQTT协议中，一个MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。MQTT数据包结构如下：

- **固定头（Fixed header）**：存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识
- **可变头（Variable header）**：存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容
- **消息体（Payload）**：存在于部分MQTT数据包中，表示客户端收到的具体消息

### MQTT固定头

&emsp;&emsp;固定报头，所有MQTT控制报文都包含，可变报头与有效载荷是部分MQTT控制报文包含。`固定报头占据两字节的空间`，具体见：

<center><img src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240610110429.png" width="50%"/></center>

&emsp;&emsp;固定报头的第一个字节分为`控制报文的类型(4 bit)`，以及控制报文类型的标志位，控制类型共有14中，其中0与15被系统保留出来，其他的类型具体见：

|类型|值|说明|
|---|---|---|
|Reserved|0|系统保留|
|CONNECT|1|客户端请求连接服务端|
|CONNACK|2|连接报文确认|
|PUBLISH|3|发布消息|
|PUBACK|4|消息发布收到确认(QoS 1)|
|PUBREC|5|发布收到(QoS 2)|
|PUBREL|6|发布释放(QoS 2)|
|PUBCOMP|7|消息发布完成(QoS 2)|
|SUBSCRIBE|8|客户端订阅请求|
|SUBACK|9|订阅请求报文确认|
|UNSUBSCRIBE|10|客户端取消订阅请求|
|UNSUBACK|11|取消订阅报文确认|
|PINGERQ|12|心跳请求|
|PINGERSP|13|心跳响应|
|DISCONNECT|14|客户端断开连接|
|Reserved|15|系统保留|

&emsp;&emsp;固定报头的`bit0~bit3`为标志位，依照报文类型有不同的含义，事实上，除了`PUBLISH`类型报文以外，其他报文的标志位均为系统保留，`PUBLISH`报文的第一个字节`bit3`是控制报文的重复分发标志（DUP），`bit1~bit2`是服务质量等级，`bit0`是PUBLISH报文的保留标志，用于标识`PUBLISH`是否保留，当客户端发送一个`PUBLISH`消息到服务器，如果保留标识位置1，那么服务器应该保留这条消息，当一个新的订阅者订阅这个主题的时候，最后保留的主题消息应被发送到新订阅的用户。
&emsp;&emsp;固定报头的第二个字节开始是剩余长度字段，是用于记录剩余报文长度的，表示当前的消息剩余的字节数，包括可变报头和有效载荷区域（如果存在），但剩余长度不包括用于编码剩余长度字段本身的字节数
&emsp;&emsp;剩余长度字段使用一个变长度编码方案，对小于128的值它使用单字节编码，而对于更大的数值则按下面的方式处理：
- 每个字节的低7位用于编码数据长度
- 最高位(`bit7`)用于标识剩余长度字段是否有更多的字节，且按照大端模式进行编码，因此每个字节可以编码128个数值和一个延续位，剩余长度字段最大可拥有4个字节
    - 当剩余长度使用1个字节存储时，其取值范围为`0(0x00)~127(0x7F)`
    - 当使用2个字节时，其取值范围为`128(0x80,0x01)~16383(0xff,0x7f)`
    - 当使用3个字节时，其取值范围为`16384(0x80,0x80,0x01)~2097151(0xFF,0xFF,0x7F)`
    - 当使用4个字节时，其取值范围为`2097152(0x80,0x80,0x80,0x01)~268435455(0xFF,0xFF,0xFF,0x7F)`

{% note danger%}
总的来说，MQTT报文理论上可以发送最大256M的报文，当然，这种情况是非常少的
{% endnote %}

&emsp;&emsp;固定头存在于所有MQTT数据包中，其结构如下：

#### MQTT数据包类型

位置：Byte1中`bit7 ~ bit4`
<center><img src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240610114343.png" width="50%"/></center>
相当于一个4位的五福好值，类型、取值及描述如下：

#### 标识位

位置：Byte1中的`bit3 ~ bit0`

<center><img src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240610114707.png" width="50%"/></center>

&emsp;&emsp;在不适用标识位的消息类型中，标识位被作为保留位。如果收到无效的标志位时，接收端必须关闭网络连接：
1. **DUP**：发布消息的副本。用来在保证消息的可靠传输，如果设置为1，则在下面的变长中增加`MessageId`，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。
1. **QoS**：发布消息的服务质量，即：保证消息传递的次数
    ```Bash
    Ø00：最多一次，即：<=1
    Ø01：至少一次，即：>=1
    Ø10：一次，即：=1
    Ø11：预留
    ```
1. **RETAIN**：发布保留标识，表示服务器要保留这次推送的消息，如果有新的订阅者出现，就把这消息推送给它，如果没有那么推送至当前订阅者后释放。

#### 剩余长度

位置：Byte2

<center><img src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240610115748.png" width="50%"/></center>

&emsp;&emsp;固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的，这一字节时可以扩展，其保存机制，前7位用于保存长度，，后一部用做标识。当最后一位位1时，表示长度不足，需要使用二个字节继续保存

### MQTT可变头

&emsp;&emsp;MQTT数据包中包含一个可变头，它驻位于固定头和负载之间。可变头的内容因数据包类型不同而不同，较常的应用是作为包的标识。

<center><img src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240610142423.png" width="50%"/></center>



